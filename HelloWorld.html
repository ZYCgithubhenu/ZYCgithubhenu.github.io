<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智能计算器</title>
  <!-- 引入Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <!-- Tailwind配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#FF7D00',
            dark: '#1E293B',
            light: '#F8FAFC',
            'dark-gray': '#334155',
            'light-gray': '#94A3B8'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
          boxShadow: {
            'btn': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
            'btn-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
          'card': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
        },
      }
    }
  </script>

  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .calc-btn {
        @apply w-full h-14 rounded-xl flex items-center justify-center text-xl font-semibold transition-all duration-300 transform hover:scale-105 active:scale-95 shadow-btn hover:shadow-btn-hover;
      }
      .number-btn {
        @apply calc-btn bg-white text-dark-gray hover:bg-gray-100;
      }
      .operator-btn {
        @apply calc-btn bg-primary/10 text-primary hover:bg-primary/20;
      }
      .function-btn {
        @apply calc-btn bg-secondary/10 text-secondary hover:bg-secondary/20;
      }
      .equal-btn {
        @apply calc-btn bg-primary text-white hover:bg-primary/90;
      }
      .display-value {
        @apply text-right text-4xl font-bold text-dark overflow-hidden text-ellipsis whitespace-nowrap;
      }
      .display-history {
        @apply text-right text-lg text-light-gray overflow-hidden text-ellipsis whitespace-nowrap;
      }
    }
  </style>
</head>
<body class="font-inter bg-gradient-to-br from-light to-gray-100 min-h-screen flex items-center justify-center p-4">
  <!-- 计算器主体 -->
  <div class="w-full max-w-md bg-white rounded-3xl shadow-card overflow-hidden transform transition-all duration-500 hover:shadow-xl">
    <!-- 显示区域 -->
    <div class="p-6 bg-white relative">
      <div class="absolute top-4 right-4 flex space-x-2">
        <button id="theme-toggle" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-dark-gray hover:bg-gray-200 transition-colors">
          <i class="fa fa-moon-o"></i>
        </button>
        <button id="history-toggle" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-dark-gray hover:bg-gray-200 transition-colors">
          <i class="fa fa-history"></i>
        </button>
      </div>

      <div id="history-container" class="absolute top-16 right-6 bg-white rounded-xl shadow-lg p-4 w-64 max-h-60 overflow-y-auto transform translate-y-0 opacity-100 transition-all duration-300 hidden">
        <h3 class="text-sm font-semibold text-light-gray mb-2">计算历史</h3>
        <div id="history-list" class="space-y-2 text-sm">
          <!-- 历史记录将在这里动态添加 -->
        </div>
      </div>

      <div class="h-32 flex flex-col justify-end">
        <div id="display-history" class="display-history mb-2">0</div>
        <div id="display-value" class="display-value">0</div>
      </div>
    </div>

    <!-- 按钮区域 -->
    <div class="p-4 bg-gray-50 grid grid-cols-4 gap-3">
      <!-- 第一行 -->
      <button class="function-btn" data-action="clear">C</button>
      <button class="function-btn" data-action="plus-minus">±</button>
      <button class="function-btn" data-action="percentage">%</button>
      <button class="operator-btn" data-action="divide">÷</button>

      <!-- 第二行 -->
      <button class="number-btn" data-number="7">7</button>
      <button class="number-btn" data-number="8">8</button>
      <button class="number-btn" data-number="9">9</button>
      <button class="operator-btn" data-action="multiply">×</button>

      <!-- 第三行 -->
      <button class="number-btn" data-number="4">4</button>
      <button class="number-btn" data-number="5">5</button>
      <button class="number-btn" data-number="6">6</button>
      <button class="operator-btn" data-action="subtract">−</button>

      <!-- 第四行 -->
      <button class="number-btn" data-number="1">1</button>
      <button class="number-btn" data-number="2">2</button>
      <button class="number-btn" data-number="3">3</button>
      <button class="operator-btn" data-action="add">+</button>

      <!-- 第五行 -->
      <button class="number-btn col-span-2" data-number="0">0</button>
      <button class="number-btn" data-action="decimal">.</button>
      <button class="equal-btn" data-action="calculate">=</button>
    </div>
  </div>

  <!-- JavaScript 逻辑 -->
  <script>
    // DOM元素
    const displayValue = document.getElementById('display-value');
    const displayHistory = document.getElementById('display-history');
    const numberButtons = document.querySelectorAll('[data-number]');
    const operatorButtons = document.querySelectorAll('[data-action]');
    const historyToggle = document.getElementById('history-toggle');
    const historyContainer = document.getElementById('history-container');
    const historyList = document.getElementById('history-list');
    const themeToggle = document.getElementById('theme-toggle');
    const calculator = document.querySelector('.max-w-md');

    // 计算器状态
    let currentValue = '0';
    let previousValue = '';
    let operator = null;
    let resetOnNextInput = false;
    let calculationHistory = [];

    // 更新显示
    function updateDisplay() {
      displayValue.textContent = currentValue;

      if (previousValue && operator) {
        displayHistory.textContent = `${previousValue} ${getOperatorSymbol(operator)}`;
      } else {
        displayHistory.textContent = '';
      }
    }

    // 获取运算符符号
    function getOperatorSymbol(op) {
      const symbols = {
        'add': '+',
        'subtract': '−',
        'multiply': '×',
        'divide': '÷',
        'percentage': '%'
      };
      return symbols[op] || op;
    }

    // 添加数字
    function appendNumber(number) {
      if (currentValue === '0' || resetOnNextInput) {
        currentValue = number;
        resetOnNextInput = false;
      } else {
        currentValue += number;
      }
      updateDisplay();
    }

    // 添加小数点
    function appendDecimal() {
      if (resetOnNextInput) {
        currentValue = '0.';
        resetOnNextInput = false;
        updateDisplay();
        return;
      }

      if (!currentValue.includes('.')) {
        currentValue += '.';
        updateDisplay();
      }
    }

    // 处理运算符
    function handleOperator(nextOperator) {
      if (nextOperator === 'clear') {
        currentValue = '0';
        previousValue = '';
        operator = null;
        resetOnNextInput = false;
        updateDisplay();
        return;
      }

      if (nextOperator === 'plus-minus') {
        currentValue = (parseFloat(currentValue) * -1).toString();
        updateDisplay();
        return;
      }

      if (nextOperator === 'percentage') {
        currentValue = (parseFloat(currentValue) / 100).toString();
        updateDisplay();
        return;
      }

      if (operator && resetOnNextInput) {
        operator = nextOperator;
        updateDisplay();
        return;
      }

      if (previousValue === '') {
        previousValue = currentValue;
      } else if (operator) {
        const currentValueFloat = parseFloat(currentValue);
        const previousValueFloat = parseFloat(previousValue);
        let newValue;

        switch (operator) {
          case 'add':
            newValue = previousValueFloat + currentValueFloat;
            break;
          case 'subtract':
            newValue = previousValueFloat - currentValueFloat;
            break;
          case 'multiply':
            newValue = previousValueFloat * currentValueFloat;
            break;
          case 'divide':
            if (currentValueFloat === 0) {
              newValue = '错误';
            } else {
              newValue = previousValueFloat / currentValueFloat;
            }
            break;
          default:
            return;
        }

        currentValue = newValue.toString();
        previousValue = '';
      }

      resetOnNextInput = true;
      operator = nextOperator;
      updateDisplay();
    }

    // 计算结果
    function calculate() {
      if (!operator || previousValue === '' || resetOnNextInput) return;

      const currentValueFloat = parseFloat(currentValue);
      const previousValueFloat = parseFloat(previousValue);
      let newValue;

      switch (operator) {
        case 'add':
          newValue = previousValueFloat + currentValueFloat;
          break;
        case 'subtract':
          newValue = previousValueFloat - currentValueFloat;
          break;
        case 'multiply':
          newValue = previousValueFloat * currentValueFloat;
          break;
        case 'divide':
          if (currentValueFloat === 0) {
            newValue = '错误';
          } else {
            newValue = previousValueFloat / currentValueFloat;
          }
          break;
        default:
          return;
      }

      // 保存到历史记录
      const calculation = `${previousValue} ${getOperatorSymbol(operator)} ${currentValue} = ${newValue}`;
      calculationHistory.push(calculation);
      updateHistoryList();

      currentValue = newValue.toString();
      previousValue = '';
      operator = null;
      resetOnNextInput = true;
      updateDisplay();
    }

    // 更新历史记录列表
    function updateHistoryList() {
      historyList.innerHTML = '';

      calculationHistory.slice().reverse().forEach((item, index) => {
        const historyItem = document.createElement('div');
        historyItem.className = 'p-2 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors';
        historyItem.textContent = item;
        historyItem.addEventListener('click', () => {
          const result = item.split('=')[1].trim();
          currentValue = result;
          updateDisplay();
          historyContainer.classList.add('hidden');
        });
        historyList.appendChild(historyItem);
      });
    }

    // 事件监听
    numberButtons.forEach(button => {
      button.addEventListener('click', () => {
        appendNumber(button.getAttribute('data-number'));
      });
    });

    operatorButtons.forEach(button => {
      button.addEventListener('click', () => {
        const action = button.getAttribute('data-action');
        if (action === 'calculate') {
          calculate();
        } else {
          handleOperator(action);
        }
      });
    });

    // 历史记录切换
    historyToggle.addEventListener('click', () => {
      historyContainer.classList.toggle('hidden');
    });

    // 点击外部关闭历史记录
    document.addEventListener('click', (event) => {
      if (!historyContainer.contains(event.target) && event.target !== historyToggle) {
        historyContainer.classList.add('hidden');
      }
    });

    // 主题切换
    let isDarkMode = false;
    themeToggle.addEventListener('click', () => {
      isDarkMode = !isDarkMode;

      if (isDarkMode) {
        document.body.classList.remove('from-light', 'to-gray-100');
        document.body.classList.add('from-dark', 'to-gray-900');
        calculator.classList.remove('bg-white');
        calculator.classList.add('bg-dark');
        themeToggle.innerHTML = '<i class="fa fa-sun-o"></i>';
      } else {
        document.body.classList.remove('from-dark', 'to-gray-900');
        document.body.classList.add('from-light', 'to-gray-100');
        calculator.classList.remove('bg-dark');
        calculator.classList.add('bg-white');
        themeToggle.innerHTML = '<i class="fa fa-moon-o"></i>';
      }
    });

    // 键盘支持
    document.addEventListener('keydown', (event) => {
      const key = event.key;

      if (!isNaN(key) || key === '.') {
        event.preventDefault();
        if (key === '.') {
          appendDecimal();
        } else {
          appendNumber(key);
        }
      } else if (key === '+') {
        event.preventDefault();
        handleOperator('add');
      } else if (key === '-') {
        event.preventDefault();
        handleOperator('subtract');
      } else if (key === '*') {
        event.preventDefault();
        handleOperator('multiply');
      } else if (key === '/') {
        event.preventDefault();
        handleOperator('divide');
      } else if (key === '%') {
        event.preventDefault();
        handleOperator('percentage');
      } else if (key === 'Enter' || key === '=') {
        event.preventDefault();
        calculate();
      } else if (key === 'Escape') {
        event.preventDefault();
        handleOperator('clear');
      } else if (key === 'Backspace') {
        event.preventDefault();
        if (currentValue.length > 1) {
          currentValue = currentValue.slice(0, -1);
        } else {
          currentValue = '0';
        }
        updateDisplay();
      }
    });

    // 初始化显示
    updateDisplay();
  </script>
</body>
</html>